<link rel="stylesheet" href="../style.css">

<body>
</body>

<script type="module">

  import { Game } from '../src/game.js';
  import { Entity } from '../src/entity.js';
  import { Segment } from '../src/segment.js';

  const walls = [
    // new Segment(  50, 150, 100, 100 ),
    new Segment( 100, 100, 200, 150 ),
    // new Segment( 200, 150, 400, 100 ),
  ];

  class Ball extends Entity {
    width = 10;
    height = 10;
    radius = 10;
    path = new Path2D( 'M -1 0 A 1 1 0 0 1 1 0 A 1 1 0 0 1 -1 0' );

    dx = 0;
    dy = 0;

    update( dt ) {
      this.x += this.dx * dt;
      this.y += this.dy * dt;
    }
  }

  const ball = new Ball( { x: 100, y: 50, fillStyle: 'yellow' } );

  const game = new Game();
  game.update = ( dt ) => {
    if ( game.mouseDown ) {
      ball.x = game.mouseX;
      ball.y = game.mouseY;
    }
  };

  game.draw = ( ctx ) => {
    walls.forEach( w => w.draw( ctx ) );

    ball.draw( ctx );

    const dt = 10;

    ball.dx = ( game.mouseX - ball.x ) / dt;
    ball.dy = ( game.mouseY - ball.y ) / dt;

    const hits = walls.map( 
      wall => wall.getCollision( ball )
    );
    const hit = hits.reduce( 
      ( closest, nextHit ) => 0 < nextHit.time && nextHit.time < closest.time ? nextHit : closest,
      { time: Infinity, normalX: 0, normalY: 0 }
    );

    const afterBall = Object.assign( new Ball(), ball );

    if ( 0 < hit.time && hit.time <= dt ) {

      afterBall.update( hit.time );
      afterBall.fillStyle = 'red';
      afterBall.draw( ctx );

      const hitX = afterBall.x, hitY = afterBall.y;

      ctx.beginPath();
      ctx.moveTo( ball.x, ball.y );
      ctx.lineTo( hitX, hitY );
      ctx.strokeStyle = 'green';
      ctx.stroke();

      // https://stackoverflow.com/questions/573084/how-to-calculate-bounce-angle
      const vDotN = ball.dx * hit.normalX + ball.dy * hit.normalY
      const uX = vDotN * hit.normalX;
      const uY = vDotN * hit.normalY;
      const wX = ball.dx - uX;
      const wY = ball.dy - uY;

      afterBall.dx = wX - uX;
      afterBall.dy = wY - uY;

      afterBall.update( dt - hit.time );

      ctx.beginPath();
      ctx.moveTo( hitX, hitY );
      ctx.lineTo( game.mouseX, game.mouseY );
      ctx.strokeStyle = 'blue';
      ctx.stroke();

      afterBall.fillStyle = 'orange';
      afterBall.draw( ctx );

      ctx.beginPath();
      ctx.moveTo( hitX, hitY );
      ctx.lineTo( afterBall.x, afterBall.y );
      ctx.strokeStyle = 'orange';
      ctx.stroke();
    }
    else {
      afterBall.update( dt );
      afterBall.fillStyle = 'orange';
      afterBall.draw( ctx );
    }
    
  };
  

</script>

